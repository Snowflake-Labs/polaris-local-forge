version: "3"

vars:
  PROJECT_HOME:
    sh: pwd
  KUBECONFIG: "{{.PROJECT_HOME}}/.kube/config"
  K3D_CLUSTER_NAME: polaris-local-forge
  K3S_VERSION: v1.31.5-k3s1
  FEATURES_DIR: "{{.PROJECT_HOME}}/k8s"

env:
  KUBECONFIG: "{{.KUBECONFIG}}"

tasks:
  # ============================================
  # Installation Tasks
  # ============================================

  install:uv:
    desc: Install uv Python package manager
    cmds:
      - |
        if ! command -v uv &> /dev/null; then
          echo "Installing uv..."
          pip install uv || curl -LsSf https://astral.sh/uv/install.sh | sh
        else
          echo "uv is already installed ($(uv --version))"
        fi
    status:
      - command -v uv

  # ============================================
  # Setup and Initialization Tasks
  # ============================================

  setup:python:
    desc: Set up Python environment using uv
    deps:
      - install:uv
    cmds:
      - uv python pin 3.12
      - uv venv
      - uv sync
      - |
        echo ""
        echo "âœ… Python environment setup complete!"
        echo ""
        echo "ðŸ“Œ Next step: Activate the virtual environment in your shell:"
        echo "   source .venv/bin/activate"
        echo ""

  setup:dnsmasq:
    desc: Configure DNSmasq for .localstack domain (macOS only)
    cmds:
      - echo "address=/.localstack/127.0.0.1" >> $(brew --prefix)/etc/dnsmasq.conf
      - sudo tee /etc/resolver/localstack <<< "nameserver 127.0.0.1"
    preconditions:
      - sh: which brew
        msg: "Homebrew is required for this task"

  prepare:
    desc: Generate required sensitive files from templates using Ansible
    preconditions:
      - sh: test -f .venv/bin/activate || test -f .venv/Scripts/activate
        msg: "Python venv not found. Run 'task setup:python' first."
    cmds:
      - uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/prepare.yml

  # ============================================
  # Cluster Management Tasks
  # ============================================

  cluster:create:
    desc: Create the k3d cluster and deploy initial components
    deps:
      - prepare
    cmds:
      - |
        export K3D_CLUSTER_NAME={{.K3D_CLUSTER_NAME}}
        export K3S_VERSION={{.K3S_VERSION}}
        export FEATURES_DIR={{.FEATURES_DIR}}
        {{.PROJECT_HOME}}/bin/setup.sh

  cluster:bootstrap-check:
    desc: Wait for bootstrap deployments to be ready
    cmds:
      - uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/cluster_checks.yml --tags=bootstrap

  cluster:polaris-check:
    desc: Wait for polaris deployments to be ready
    cmds:
      - uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/cluster_checks.yml --tags=polaris

  cluster:delete:
    desc: Delete the k3d cluster
    cmds:
      - |
        export K3D_CLUSTER_NAME={{.K3D_CLUSTER_NAME}}
        {{.PROJECT_HOME}}/bin/cleanup.sh

  cluster:reset:
    desc: Delete and recreate cluster with fresh catalog
    cmds:
      - task: cluster:delete
      - task: cluster:create
      - task: cluster:bootstrap-check
      - task: polaris:deploy
      - task: cluster:polaris-check
      - task: catalog:setup
      - 'echo ""'
      - 'echo "âœ… Cluster reset complete!"'
      - 'echo "All services are running with a fresh catalog"'

  # ============================================
  # Polaris Deployment Tasks
  # ============================================

  polaris:deploy:
    desc: Deploy Polaris to the cluster
    cmds:
      - kubectl apply -k {{.PROJECT_HOME}}/k8s/polaris

  polaris:check:
    desc: Ensure all Polaris deployments and jobs have succeeded
    cmds:
      - uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/cluster_checks.yml --tags=polaris

  polaris:purge:
    desc: Purge Polaris data
    cmds:
      - kubectl patch job polaris-purge -n polaris -p '{"spec":{"suspend":false}}'
      - echo "Waiting for purge to complete..."
      - kubectl wait --for=condition=complete --timeout=300s job/polaris-purge -n polaris
      - kubectl logs -n polaris jobs/polaris-purge

  polaris:bootstrap:
    desc: Bootstrap Polaris (run after purge)
    cmds:
      - kubectl delete -k {{.PROJECT_HOME}}/k8s/polaris/job
      - kubectl apply -k {{.PROJECT_HOME}}/k8s/polaris/job
      - echo "Waiting for bootstrap to complete..."
      - kubectl wait --for=condition=complete --timeout=300s job/polaris-bootstrap -n polaris
      - kubectl logs -n polaris jobs/polaris-bootstrap

  polaris:reset:
    desc: Purge and re-bootstrap Polaris
    cmds:
      - task: polaris:purge
      - task: polaris:bootstrap

  # ============================================
  # Catalog Management Tasks
  # ============================================

  catalog:setup:
    desc: Set up demo catalog with s3 bucket, catalog, principal, and roles
    cmds:
      - |
        export AWS_ENDPOINT_URL=http://localhost:4566
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_REGION=us-east-1
        unset AWS_PROFILE
        uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/catalog_setup.yml

  catalog:generate-notebook:
    desc: Generate and prepare verification notebook
    cmds:
      - |
        export AWS_ENDPOINT_URL=http://localhost:4566
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_REGION=us-east-1
        unset AWS_PROFILE
        uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/catalog_setup.yml --tags=verify
      - echo "Run the notebook at {{.PROJECT_HOME}}/notebooks/verify_setup.ipynb"

  catalog:verify:duckdb:
    desc: Verify Polaris catalog using DuckDB Iceberg extension
    cmds:
      - |
        export AWS_ENDPOINT_URL=http://localhost:4566
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_REGION=us-east-1
        unset AWS_PROFILE
        uv run python {{.PROJECT_HOME}}/scripts/explore_catalog.py {{.CLI_ARGS}}
    preconditions:
      - sh: test -f {{.PROJECT_HOME}}/work/principal.txt
        msg: "Principal credentials not found. Run 'task catalog:setup' first."

  verify:
    desc: Verify Polaris catalog setup (alias for catalog:verify:duckdb)
    cmds:
      - task: catalog:verify:duckdb
        vars:
          CLI_ARGS: "{{.CLI_ARGS}}"

  catalog:info:
    desc: Get catalog configuration details from Polaris API
    cmds:
      - |
        echo "Fetching catalog configuration..."
        REALM=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f1)
        CLIENT_ID=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f2)
        CLIENT_SECRET=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f3)

        # Get access token
        TOKEN=$(curl -s -X POST "http://localhost:18181/api/catalog/v1/oauth/tokens" \
          -H "Authorization: Bearer ${CLIENT_ID}:${CLIENT_SECRET}" \
          -H "Polaris-Realm: ${REALM}" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&scope=PRINCIPAL_ROLE:ALL" \
          | jq -r '.access_token')

        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "âŒ Failed to get access token"
          exit 1
        fi

        echo ""
        echo "=== Catalog Configuration for 'polardb' ==="
        echo ""

        # Get catalog configuration
        curl -s "http://localhost:18181/api/management/v1/catalogs/polardb" \
          -H "Authorization: Bearer ${TOKEN}" \
          -H "Polaris-Realm: ${REALM}" \
          | jq '.'

        echo ""
        echo "=== Key S3 Configuration ==="
        echo ""
        curl -s "http://localhost:18181/api/management/v1/catalogs/polardb" \
          -H "Authorization: Bearer ${TOKEN}" \
          -H "Polaris-Realm: ${REALM}" \
          | jq '{
              properties: .catalog.properties,
              storageConfigInfo: .catalog.storageConfigInfo
            }'
    preconditions:
      - sh: test -f {{.PROJECT_HOME}}/work/principal.txt
        msg: "Credentials file not found. Run 'task catalog:setup' first."
      - sh: command -v jq
        msg: "jq is required for this task. Install with: brew install jq"

  catalog:cleanup:
    desc: Cleanup Polaris catalog resources
    cmds:
      - |
        export AWS_ENDPOINT_URL=http://localhost:4566
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_REGION=us-east-1
        unset AWS_PROFILE
        uv run ansible-playbook {{.PROJECT_HOME}}/polaris-forge-setup/catalog_cleanup.yml

  catalog:reset:
    desc: Cleanup and recreate catalog (keeps cluster running)
    cmds:
      - task: catalog:cleanup
      - task: catalog:setup
      - 'echo ""'
      - 'echo "âœ… Catalog reset complete!"'
      - 'echo ""'
      - 'echo "ðŸ“ Verification options:"'
      - 'echo "  - Run DuckDB verification: task verify"'
      - 'echo "  - Generate notebook: task catalog:generate-notebook"'

  catalog:reset:full:
    desc: Full reset - purge Polaris database and recreate catalog
    cmds:
      - echo "âš ï¸  This will purge the entire Polaris database and recreate from scratch"
      - task: polaris:reset
      - task: catalog:setup
      - 'echo ""'
      - 'echo "âœ… Full catalog reset complete!"'
      - 'echo "Polaris database was purged and catalog recreated"'
      - 'echo ""'
      - 'echo "ðŸ“ Verification options:"'
      - 'echo "  - Run DuckDB verification: task verify"'
      - 'echo "  - Generate notebook: task catalog:generate-notebook"'

  # ============================================
  # Logging and Troubleshooting Tasks
  # ============================================

  logs:polaris:
    desc: Stream Polaris server logs
    cmds:
      - kubectl logs -f -n polaris deployment/polaris

  logs:bootstrap:
    desc: View Polaris bootstrap job logs
    cmds:
      - kubectl logs -f -n polaris jobs/polaris-bootstrap

  logs:purge:
    desc: View Polaris purge job logs
    cmds:
      - kubectl logs -f -n polaris jobs/polaris-purge

  logs:postgresql:
    desc: Stream PostgreSQL logs
    cmds:
      - kubectl logs -f -n polaris statefulset/postgresql

  logs:localstack:
    desc: Stream LocalStack logs
    cmds:
      - kubectl logs -f -n localstack deployment/localstack

  # ============================================
  # Troubleshooting Tasks
  # ============================================

  troubleshoot:events:
    desc: Show recent events in polaris namespace
    cmds:
      - kubectl get events -n polaris --sort-by='.lastTimestamp'

  troubleshoot:polaris:
    desc: Troubleshoot Polaris deployment issues
    cmds:
      - kubectl get events -n polaris --sort-by='.lastTimestamp'
      - kubectl describe pod -n polaris -l app=polaris

  troubleshoot:localstack:
    desc: Troubleshoot LocalStack connectivity
    cmds:
      - kubectl get svc -n localstack
      - kubectl exec -it -n localstack deployment/localstack -- aws --endpoint-url=http://localhost:4566 s3 ls

  troubleshoot:postgresql:
    desc: Troubleshoot PostgreSQL connectivity
    cmds:
      - kubectl get svc -n polaris postgresql-hl
      - kubectl exec -it -n polaris postgresql-0 -- pg_isready -h localhost

  # ============================================
  # Convenience Compound Tasks
  # ============================================

  setup:all:
    desc: Complete setup - prepare files, create cluster, deploy Polaris, setup catalog
    cmds:
      - task: cluster:create
      - task: cluster:bootstrap-check
      - task: polaris:deploy
      - task: cluster:polaris-check
      - task: catalog:setup
      - task: verify
      - 'echo ""'
      - 'echo "âœ… Setup complete ðŸŽ‰"'
      - 'echo ""'
      - 'echo "ðŸ“ Additional verification options:"'
      - 'echo "  - Run DuckDB verification again: task verify"'
      - 'echo "  - Generate PyIceberg notebook: task catalog:generate-notebook"'
      - 'echo "  - Open notebook at: {{.PROJECT_HOME}}/notebooks/verify_setup.ipynb"'

  reset:all:
    desc: Complete reset - delete cluster, recreate everything with fresh catalog
    cmds:
      - task: cluster:reset

  clean:all:
    desc: Delete cluster and all resources
    cmds:
      - task: cluster:delete

  # ============================================
  # Quick Reference Tasks
  # ============================================

  status:
    desc: Show status of all deployments
    cmds:
      - echo "=== Polaris Namespace ==="
      - kubectl get all -n polaris
      - echo ""
      - echo "=== LocalStack Namespace ==="
      - kubectl get all -n localstack

  urls:
    desc: Display service URLs and credentials locations
    cmds:
      - 'echo "Service URLs:"'
      - 'echo "  Polaris UI:  http://localhost:18181"'
      - 'echo "  Credentials: {{.PROJECT_HOME}}/k8s/polaris/.bootstrap-credentials.env"'
      - 'echo ""'
      - 'echo "  Adminer:     http://localhost:18080"'
      - 'echo "  PostgreSQL:  postgresql.polaris (check {{.FEATURES_DIR}}/postgresql.yaml)"'
      - 'echo ""'
      - 'echo "  LocalStack:  http://localhost:14566"'
      - 'echo "  Credentials: test/test"'

  help:
    desc: Show available tasks with descriptions
    cmds:
      - task --list
