#!/usr/bin/env ansible-playbook
# Copyright 2025 Snowflake Inc.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
# API Query Playbook for Apache Polaris (Generic Endpoint Pattern)
#
# Usage (SKILL.md constructs the endpoint dynamically):
#   ansible-playbook api_query.yml -e "plf_output_base=/path/to/workdir" -e "endpoint=/api/management/v1/catalogs"
#   ansible-playbook api_query.yml -e "plf_output_base=/path/to/workdir" -e "endpoint=/api/catalog/v1/polardb/namespaces"
#   ansible-playbook api_query.yml -e "plf_output_base=/path/to/workdir" -e "endpoint=/api/catalog/v1/polardb/namespaces/default/tables"
#
# Parameters:
#   plf_output_base (required): Path to work directory containing credentials
#   endpoint (required): The API endpoint path (e.g., /api/management/v1/catalogs)
#   method (optional): HTTP method, defaults to GET (read-only operations only in this phase)
#
# Supported Endpoints (see SKILL.md for full mapping):
#   Management API (/api/management/v1/...):
#     - /catalogs, /catalogs/{name}
#     - /principals, /principals/{name}
#     - /principal-roles, /principal-roles/{name}
#     - /catalogs/{catalog}/catalog-roles, /catalogs/{catalog}/catalog-roles/{role}
#     - /catalogs/{catalog}/catalog-roles/{role}/grants
#   Catalog API (/api/catalog/v1/...):
#     - /{catalog}/namespaces, /{catalog}/namespaces/{ns}
#     - /{catalog}/namespaces/{ns}/tables, /{catalog}/namespaces/{ns}/tables/{table}
#     - /{catalog}/namespaces/{ns}/views, /{catalog}/namespaces/{ns}/views/{view}

- name: Query Apache Polaris REST API
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - defaults/main.yml

  vars:
    # Required: endpoint path constructed by SKILL.md
    endpoint: ""
    # HTTP method (GET only for read operations - this phase)
    method: "GET"
    # Credentials file location
    principal_file: "{{ plf_work_dir }}/principal.txt"

  tasks:
    # =========================================================================
    # Validate Required Parameters
    # =========================================================================

    - name: Validate endpoint parameter
      ansible.builtin.fail:
        msg: "Required parameter 'endpoint' not provided. Usage: -e \"endpoint=/api/management/v1/catalogs\""
      when: endpoint == ""
      tags:
        - validate

    # =========================================================================
    # Load .env Configuration (user overrides)
    # =========================================================================

    - name: Read project .env file
      ansible.builtin.slurp:
        src: "{{ plf_output_base }}/.env"
      register: env_content
      ignore_errors: true
      tags:
        - config

    - name: Parse .env catalog name
      ansible.builtin.set_fact:
        env_catalog: "{{ (env_content.content | b64decode | regex_search('PLF_POLARIS_CATALOG_NAME=(.+)', '\\1'))[0] }}"
      when: env_content is succeeded and (env_content.content | b64decode | regex_search('PLF_POLARIS_CATALOG_NAME=(.+)'))
      tags:
        - config

    # =========================================================================
    # Authentication (credentials hidden with no_log)
    # =========================================================================

    - name: Read principal credentials
      ansible.builtin.slurp:
        src: "{{ principal_file }}"
      register: principal_content
      no_log: true
      tags:
        - auth

    - name: Parse principal credentials
      ansible.builtin.set_fact:
        principal_parts: "{{ (principal_content.content | b64decode | trim).split(',') }}"
      no_log: true
      tags:
        - auth

    - name: Set credential variables
      ansible.builtin.set_fact:
        plf_realm: "{{ principal_parts[0] }}"
        plf_client_id: "{{ principal_parts[1] }}"
        plf_client_secret: "{{ principal_parts[2] }}"
      no_log: true
      tags:
        - auth

    - name: Get OAuth access token
      ansible.builtin.uri:
        url: "{{ plf_api_base_url }}/api/catalog/v1/oauth/tokens"
        method: POST
        headers:
          accept: application/json
          content-type: application/x-www-form-urlencoded
          Polaris-Realm: "{{ plf_realm }}"
        body_format: form-urlencoded
        body:
          grant_type: client_credentials
          client_id: "{{ plf_client_id }}"
          client_secret: "{{ plf_client_secret }}"
          scope: "PRINCIPAL_ROLE:ALL"
        status_code: [200]
      register: token_response
      no_log: true
      tags:
        - auth

    - name: Set auth headers
      ansible.builtin.set_fact:
        auth_headers:
          Authorization: "Bearer {{ token_response.json.access_token }}"
          accept: application/json
          content-type: application/json
          Polaris-Realm: "{{ plf_realm }}"
      no_log: true
      tags:
        - auth

    # =========================================================================
    # Generic API Query (endpoint constructed by SKILL.md)
    # =========================================================================

    - name: "API: Execute query"
      ansible.builtin.uri:
        url: "{{ plf_api_base_url }}{{ endpoint }}"
        method: "{{ method }}"
        headers: "{{ auth_headers }}"
        status_code: [200, 204]
      register: result
      tags:
        - query

    # =========================================================================
    # Output (JSON for easy formatting by Cortex Code)
    # =========================================================================

    - name: "Output: Query result"
      ansible.builtin.debug:
        var: result.json
      when: result.json is defined
      tags:
        - output

    - name: "Output: No content response"
      ansible.builtin.debug:
        msg: "Request successful (no content returned)"
      when: result.json is not defined and result.status == 204
      tags:
        - output
