# Copyright 2025 Snowflake Inc.
# SPDX-License-Identifier: Apache-2.0

version: "3"

silent: true

tasks:
  setup:
    desc: Set up demo catalog with s3 bucket, catalog, principal, and roles
    cmds:
      - "{{.PLF}} catalog setup {{if .TAGS}}--tags={{.TAGS}}{{end}}"

  verify:sql:
    desc: Verify Polaris catalog using DuckDB CLI with SQL script
    cmds:
      - |
        if [ -f {{.PROJECT_HOME}}/scripts/explore_catalog.sql ]; then
          duckdb < {{.PROJECT_HOME}}/scripts/explore_catalog.sql
        else
          echo "SQL script not found. Run 'task catalog:setup' first to generate it."
          exit 1
        fi
    preconditions:
      - sh: command -v duckdb
        msg: "DuckDB CLI not found. Install from https://duckdb.org/docs/installation/"

  explore:sql:
    desc: Explore Polaris catalog with DuckDB CLI in interactive mode
    cmds:
      - |
        if [ -f {{.PROJECT_HOME}}/scripts/explore_catalog.sql ]; then
          duckdb -init {{.PROJECT_HOME}}/scripts/explore_catalog.sql
        else
          echo "SQL script not found. Run 'task catalog:setup' first to generate it."
          exit 1
        fi
    preconditions:
      - sh: command -v duckdb
        msg: "DuckDB CLI not found. Install from https://duckdb.org/docs/installation/"

  query:
    desc: Execute read-only SQL query against catalog (no data insertion)
    cmds:
      - '{{.PLF}} catalog query --sql "{{.SQL}}"'
    requires:
      vars: [SQL]
    preconditions:
      - sh: command -v duckdb
        msg: "DuckDB CLI not found. Install from https://duckdb.org/docs/installation/"
      - sh: test -f {{.PROJECT_HOME}}/work/principal.txt
        msg: "Credentials file not found. Run 'task catalog:setup' first."

  info:
    desc: Get catalog configuration details from Polaris API
    cmds:
      - |
        echo "Fetching catalog configuration..."
        REALM=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f1)
        CLIENT_ID=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f2)
        CLIENT_SECRET=$(head -1 {{.PROJECT_HOME}}/work/principal.txt | cut -d',' -f3)

        # Get access token (credentials passed via stdin to avoid exposure in process list)
        TOKEN=$(echo "grant_type=client_credentials&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&scope=PRINCIPAL_ROLE:ALL" | \
          curl -s -X POST "http://localhost:18181/api/catalog/v1/oauth/tokens" \
          -H "Authorization: Bearer ${CLIENT_ID}:${CLIENT_SECRET}" \
          -H "Polaris-Realm: ${REALM}" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d @- \
          | jq -r '.access_token')

        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "Error: Failed to get access token"
          exit 1
        fi

        echo ""
        echo "=== Catalog Configuration for 'polardb' ==="
        echo ""

        # Get catalog configuration
        curl -s "http://localhost:18181/api/management/v1/catalogs/polardb" \
          -H "Authorization: Bearer ${TOKEN}" \
          -H "Polaris-Realm: ${REALM}" \
          | jq '.'

        echo ""
        echo "=== Key S3 Configuration ==="
        echo ""
        curl -s "http://localhost:18181/api/management/v1/catalogs/polardb" \
          -H "Authorization: Bearer ${TOKEN}" \
          -H "Polaris-Realm: ${REALM}" \
          | jq '{
              properties: .properties,
              storageConfigInfo: .storageConfigInfo
            }'
    preconditions:
      - sh: test -f {{.PROJECT_HOME}}/work/principal.txt
        msg: "Credentials file not found. Run 'task catalog:setup' first."
      - sh: command -v jq
        msg: "jq is required for this task. Install with: brew install jq"

  cleanup:
    desc: Cleanup Polaris catalog resources
    cmds:
      - "{{.PLF}} catalog cleanup --yes {{if .TAGS}}--tags={{.TAGS}}{{end}}"

  list:
    desc: List catalogs in Polaris
    cmds:
      - |
        echo "Fetching catalogs from Polaris API..."
        curl -s http://localhost:18181/api/catalog/v1/config | jq '.defaults["warehouse"], .overrides | keys' 2>/dev/null || echo "Polaris not running or API unavailable"

  reset:
    desc: Cleanup and recreate catalog (keeps cluster running)
    cmds:
      - task: cleanup
      - task: setup
      - 'echo ""'
      - 'echo "Catalog reset complete."'
      - 'echo ""'
      - 'echo "Verification options:"'
      - 'echo "  - Run DuckDB verification: task verify"'
      - 'echo "  - Generate notebook: task catalog:generate-notebook"'

